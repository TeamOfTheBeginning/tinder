name: Deploy To EC2
on:
  push:
    branches:
      - DH

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: Allow insecure Docker registry
        run: |
          sudo mkdir -p /etc/docker
          echo '{ "insecure-registries":["${{ secrets.REGISTRY }}"] }' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker


      ## ğŸ”¹ ì„œë²„ ë¹Œë“œ ë° ë°°í¬ ğŸ”¹
      - name: JDK 17ë²„ì „ ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Print working directory
        run: pwd

      - name: List files
        run: ls -la

      - name: application.yml íŒŒì¼ ë§Œë“¤ê¸°
        run: echo "${{ secrets.APPLICATION_YML }}" > ./src/main/resources/application.yml

      - name: í´ë¼ì´ì–¸íŠ¸ .env íŒŒì¼ ë§Œë“¤ê¸°
        run: echo "${{ secrets.CLIENT_ENV }}" > ./client/.env  # .env íŒŒì¼ì„ í´ë¼ì´ì–¸íŠ¸ ë””ë ‰í† ë¦¬ì— ìƒì„±

      - name: gradlew permision ìˆ˜ì •
        run: sudo chmod 777 ./gradlew

      - name: ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: ./gradlew clean build -x test

      - name: ì„œë²„ Docker ì´ë¯¸ì§€ ìƒì„±
        run: docker build -t ${{ secrets.REGISTRY }}/server-app -f Dockerfile .

      - name: ì„œë²„ Docker ì´ë¯¸ì§€ íƒœê¹…
        run: docker tag ${{ secrets.REGISTRY }}/server-app ${{ secrets.REGISTRY }}/server-app:latest

      - name: ì„œë²„ Docker ì´ë¯¸ì§€ Push
        run: docker push ${{ secrets.REGISTRY }}/server-app:latest
        timeout-minutes: 30  # â¬…ï¸ ê°œë³„ ëª…ë ¹ ì‹¤í–‰ ì‹œê°„ (30ë¶„)

      ## ğŸ”¹ í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ë° ë°°í¬ ğŸ”¹
      - name: í´ë¼ì´ì–¸íŠ¸ Docker ì´ë¯¸ì§€ ìƒì„±
        working-directory: ./client  # âœ… í´ë¼ì´ì–¸íŠ¸ ë””ë ‰í† ë¦¬ ì§€ì •
        run: docker build -t ${{ secrets.REGISTRY }}/client-app -f Dockerfile .

      - name: í´ë¼ì´ì–¸íŠ¸ Docker ì´ë¯¸ì§€ íƒœê¹…
        working-directory: ./client  # í´ë¼ì´ì–¸íŠ¸ ê²½ë¡œ ì§€ì •
        run: docker tag ${{ secrets.REGISTRY }}/client-app ${{ secrets.REGISTRY }}/client-app:latest

      - name: í´ë¼ì´ì–¸íŠ¸ Docker ì´ë¯¸ì§€ Push
        run: docker push ${{ secrets.REGISTRY }}/client-app:latest
        timeout-minutes: 30  # â¬…ï¸ ê°œë³„ ëª…ë ¹ ì‹¤í–‰ ì‹œê°„ (30ë¶„)

      ## ğŸ”¹ EC2ì— ë°°í¬ ğŸ”¹
      - name: SSHë¡œ EC2 ì ‘ì† ë° ë°°í¬
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            # ì„œë²„ ì»¨í…Œì´ë„ˆ ë°°í¬
            docker stop server-app || true
            docker rm server-app || true
            docker pull ${{ secrets.REGISTRY }}/server-app:latest
            docker run -d --name server-app -p 8070:8070 \
              -v ~/userimg:/home/dhk/tinder/src/main/webapp/userimg \
              ${{ secrets.REGISTRY }}/server-app:latest

            # í´ë¼ì´ì–¸íŠ¸ ì»¨í…Œì´ë„ˆ ë°°í¬
            docker stop client-app || true
            docker rm client-app || true
            docker pull ${{ secrets.REGISTRY }}/client-app:latest
            docker run -d --name client-app -p 3000:3000 \
              ${{ secrets.REGISTRY }}/client-app:latest

            # ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
            docker ps -a